---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import Footer from "@/components/Footer.astro";

// Interactive components
import VSPlayground from "@/components/interactives/VSPlayground";
import TypicalityBiasExplainer from "@/components/interactives/TypicalityBiasExplainer";
import TemperatureAblation from "@/components/interactives/TemperatureAblation";

// Evidence components
import DiversityGainsVisual from "@/components/evidence/DiversityGainsVisual";
import PostTrainingVisual from "@/components/evidence/PostTrainingVisual";
import USStatesDemo from "@/components/evidence/USStatesDemo";
import ScalingTrendVisualization from "@/components/evidence/ScalingTrendVisualization";

// Section components
import QuickStart from "@/components/sections/QuickStart";
import QualitativeExamples from "@/components/sections/QualitativeExamples";
import VSVariantsComparison from "@/components/sections/VSVariantsComparison";

// UI components
import CodeBlock from "@/components/ui/CodeBlock";
import PromptCard from "@/components/ui/PromptCard";

// Data
import playgroundData from "@/data/precomputed/playground-data.json";
import paperEvidence from "@/data/paper-evidence/creative-writing.json";

const pageTitle = "Breaking Mode Collapse: How Verbalized Sampling Restores LLM Creativity";
const pageDescription = "Ask for a distribution, not a single answer. A training-free method to restore diversity in aligned LLMs.";
---

<Layout title={pageTitle} description={pageDescription}>
  <Header />
  <main id="main-content" class="prose prose-lg max-w-4xl mx-auto px-4 py-8">

    <!-- Hero Section -->
    <header class="not-prose mb-12 text-center">
      <h1 class="text-4xl md:text-5xl font-bold text-gray-900 mb-4">
        Breaking Mode Collapse: How Verbalized Sampling Restores LLM Creativity
      </h1>
      <p class="text-xl text-gray-600">
        Ask for a <span class="font-bold text-blue-600">distribution</span>, not a single answer
      </p>

      <!-- Training-Free Badge -->
      <div class="flex justify-center gap-3 mt-6">
        <span class="inline-flex items-center px-4 py-2 rounded-full bg-green-100 text-green-800 font-semibold">
          ‚ú® Training-Free
        </span>
        <span class="inline-flex items-center px-4 py-2 rounded-full bg-blue-100 text-blue-800 font-semibold">
          üöÄ Works with GPT, Claude, Gemini
        </span>
        <span class="inline-flex items-center px-4 py-2 rounded-full bg-purple-100 text-purple-800 font-semibold">
          üìà 1.6-2.1√ó Diversity Gain
        </span>
      </div>
    </header>

    <!-- Quick Start Section -->
    <section class="not-prose mb-12">
      <QuickStart client:load />
    </section>

    <!-- TL;DR Box -->
    <div class="not-prose bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-12">
      <h2 class="text-2xl font-bold mb-4">TL;DR</h2>
      <ul class="space-y-2">
        <li class="flex items-start gap-2">
          <span class="text-blue-500 mt-1">‚Ä¢</span>
          <span>RLHF creates <strong>typicality bias</strong> (Œµ>0) ‚Üí mode collapse (œÅ=1+Œµ/Œ≤>1)</span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-500 mt-1">‚Ä¢</span>
          <span>VS recovers diversity by prompting for <strong>probability distributions</strong></span>
        </li>
        <li class="flex items-start gap-2">
          <span class="text-blue-500 mt-1">‚Ä¢</span>
          <span>Threshold œÑ lets you <strong>tune diversity</strong> without retraining</span>
        </li>
      </ul>
    </div>

    <!-- Three-Panel Why It Works -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">Why It Works</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- Panel 1: Hidden Bias -->
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <h3 class="font-semibold text-lg mb-3">1. Hidden Bias</h3>
          <p class="text-gray-600 mb-4">
            Human annotators prefer familiar, typical text (cognitive psychology: mere-exposure effect, processing fluency)
          </p>
          <div class="bg-gray-50 rounded p-3">
            <code class="text-sm">r(x,y) = r_true(x,y) + Œµ¬∑log(p_base)</code>
            <p class="text-xs text-gray-500 mt-2">Œµ>0 confirmed in preference data</p>
          </div>
        </div>

        <!-- Panel 2: Mathematical Collapse -->
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <h3 class="font-semibold text-lg mb-3">2. Mathematical Collapse</h3>
          <p class="text-gray-600 mb-4">
            Typicality bias sharpens distributions, causing mode collapse when many answers have equal utility
          </p>
          <div class="bg-gray-50 rounded p-3">
            <code class="text-sm">œÄ*(y|x) ‚àù œÄ_ref(y|x)^œÅ</code>
            <p class="text-xs text-gray-500 mt-2">œÅ = 1 + Œµ/Œ≤ > 1 (sharpening)</p>
          </div>
        </div>

        <!-- Panel 3: VS Recovery -->
        <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
          <h3 class="font-semibold text-lg mb-3">3. VS Recovery</h3>
          <p class="text-gray-600 mb-4">
            Distribution-level prompts recover pretraining diversity by changing what the "mode" represents
          </p>
          <div class="bg-gray-50 rounded p-3">
            <code class="text-sm">KL(VS || Pretraining) ‚âà 0.12</code>
            <p class="text-xs text-gray-500 mt-2">US states demo (Figure 2)</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Interactive Typicality Bias Explainer -->
    <section class="not-prose mb-12">
      <TypicalityBiasExplainer client:visible />
    </section>

    <!-- VS Playground -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">Try It: Diversity Playground</h2>
      <VSPlayground client:visible data={playgroundData} />
    </section>

    <!-- Evidence Section -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">Evidence</h2>

      <!-- Primary Evidence Cards -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <div class="bg-white rounded-lg p-6 border-2 border-green-200">
          <div class="text-4xl font-bold text-green-600 mb-2">1.6-2.1√ó</div>
          <div class="font-semibold mb-1">Diversity Gains</div>
          <div class="text-sm text-gray-600">Creative writing tasks</div>
          <div class="text-xs text-gray-500 mt-2">Figure 3a-c, pp. 7-8</div>
        </div>

        <div class="bg-white rounded-lg p-6 border-2 border-blue-200">
          <div class="text-4xl font-bold text-blue-600 mb-2">+25.7%</div>
          <div class="font-semibold mb-1">Human Preference</div>
          <div class="text-sm text-gray-600">Rated higher by humans</div>
          <div class="text-xs text-gray-500 mt-2">Table 3, p. 8</div>
        </div>

        <div class="bg-white rounded-lg p-6 border-2 border-purple-200">
          <div class="text-4xl font-bold text-purple-600 mb-2">66.8%</div>
          <div class="font-semibold mb-1">Diversity Retained</div>
          <div class="text-sm text-gray-600">After alignment</div>
          <div class="text-xs text-gray-500 mt-2">Figure 4, p. 9</div>
        </div>
      </div>

      <!-- Diversity Gains Visualization -->
      <DiversityGainsVisual client:visible data={paperEvidence} />

      <!-- Post-Training Retention -->
      <div class="mt-8">
        <PostTrainingVisual client:visible />
      </div>
    </section>

    <!-- NEW: Temperature Orthogonality Section -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">VS ‚â† Temperature: Orthogonal Benefits</h2>
      <div class="bg-amber-50 border-l-4 border-amber-400 p-4 rounded-r-lg mb-6">
        <p class="font-semibold text-amber-900 mb-1">Common Misconception</p>
        <p class="text-amber-800">
          "Can't I just increase temperature?" No! VS and temperature are orthogonal improvements.
          VS changes WHAT is generated (distribution vs instance), while temperature affects HOW it's sampled.
        </p>
      </div>
      <TemperatureAblation client:visible />
    </section>

    <!-- NEW: Scaling Trend Section -->
    <section class="not-prose mb-12">
      <ScalingTrendVisualization client:visible />
    </section>

    <!-- NEW: VS Beats Fine-tuned Models Callout -->
    <section class="not-prose mb-12">
      <div class="bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl p-8 text-center">
        <h3 class="text-2xl font-bold mb-4">üéØ VS Matches Fine-Tuned Models</h3>
        <p class="text-lg text-gray-700 mb-4">
          In dialogue simulation, GPT-4 with VS matches the performance of a
          <span class="font-semibold">fine-tuned Llama-3.1-8B model</span>,
          and DeepSeek-R1 with VS even surpasses it.
        </p>
        <p class="text-sm text-gray-600">
          No training required - just better prompting (Figure 6a, p. 11)
        </p>
      </div>
    </section>

    <!-- US States Demo -->
    <section class="not-prose mb-12">
      <USStatesDemo client:visible />
    </section>

    <!-- VS Variants Comparison -->
    <section class="not-prose mb-12">
      <VSVariantsComparison client:visible />
    </section>

    <!-- Qualitative Examples -->
    <section class="not-prose mb-12">
      <QualitativeExamples client:visible />
    </section>

    <!-- Decision Tree -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">Is VS Right for You?</h2>
      <div class="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
        <div class="space-y-4">
          <div class="flex items-start gap-4">
            <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-green-600 font-bold">‚úì</span>
            </div>
            <div>
              <p class="font-semibold">Use VS if you need:</p>
              <ul class="text-sm text-gray-600 mt-1 space-y-1">
                <li>‚Ä¢ Creative diversity (stories, jokes, ideas)</li>
                <li>‚Ä¢ Realistic distributions (simulation, surveys)</li>
                <li>‚Ä¢ Synthetic data variety</li>
                <li>‚Ä¢ Training-free solution</li>
              </ul>
            </div>
          </div>

          <div class="flex items-start gap-4">
            <div class="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center flex-shrink-0">
              <span class="text-red-600 font-bold">√ó</span>
            </div>
            <div>
              <p class="font-semibold">Skip VS if you need:</p>
              <ul class="text-sm text-gray-600 mt-1 space-y-1">
                <li>‚Ä¢ Single correct answer (math, facts)</li>
                <li>‚Ä¢ Maximum speed (adds overhead)</li>
                <li>‚Ä¢ Deterministic output</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Implementation Tips -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">Implementation Tips</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="bg-blue-50 rounded-lg p-4">
          <h3 class="font-semibold mb-2">‚úÖ Do</h3>
          <ul class="text-sm space-y-1">
            <li>‚Ä¢ Use k=5 for optimal quality/diversity</li>
            <li>‚Ä¢ Ask for "probability" (not "likelihood")</li>
            <li>‚Ä¢ Specify JSON format for parsing</li>
            <li>‚Ä¢ Set œÑ threshold for diversity control</li>
          </ul>
        </div>
        <div class="bg-red-50 rounded-lg p-4">
          <h3 class="font-semibold mb-2">‚ùå Don't</h3>
          <ul class="text-sm space-y-1">
            <li>‚Ä¢ Use k>10 (quality degrades)</li>
            <li>‚Ä¢ Mix probability/confidence terms</li>
            <li>‚Ä¢ Forget to normalize probabilities</li>
            <li>‚Ä¢ Apply to factual/math tasks</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- FAQ Section -->
    <section class="not-prose mb-12">
      <h2 class="text-3xl font-bold mb-6">Frequently Asked Questions</h2>
      <div class="space-y-4">
        <details class="bg-white rounded-lg p-4 border border-gray-200">
          <summary class="font-semibold cursor-pointer">Does VS hurt accuracy or safety?</summary>
          <p class="mt-3 text-gray-600">
            No. The paper shows VS maintains factual accuracy (Appendix G.7) and safety (Appendix G.8).
            It only increases diversity for tasks with multiple valid answers.
          </p>
        </details>

        <details class="bg-white rounded-lg p-4 border border-gray-200">
          <summary class="font-semibold cursor-pointer">What is semantic diversity?</summary>
          <p class="mt-3 text-gray-600">
            Semantic diversity = 1 - mean(pairwise cosine similarity). It measures how different
            the meanings are across generated responses, not just surface-level word differences.
          </p>
        </details>

        <details class="bg-white rounded-lg p-4 border border-gray-200">
          <summary class="font-semibold cursor-pointer">Why not just use temperature?</summary>
          <p class="mt-3 text-gray-600">
            Temperature and VS are orthogonal. Temperature affects sampling randomness from the same
            distribution, while VS changes the distribution itself. Combining them gives best results.
          </p>
        </details>

        <details class="bg-white rounded-lg p-4 border border-gray-200">
          <summary class="font-semibold cursor-pointer">Which models support VS?</summary>
          <p class="mt-3 text-gray-600">
            Any instruction-following LLM: GPT-4, Claude, Gemini, Llama, Qwen, and even reasoning
            models like o1 and DeepSeek R1. No special access or modifications needed.
          </p>
        </details>
      </div>
    </section>

    <!-- Citation -->
    <section class="not-prose mb-12 bg-gray-50 rounded-lg p-6">
      <h2 class="text-2xl font-bold mb-4">Citation</h2>
      <CodeBlock
        code={`@article{zhang2025verbalized,
  title={Verbalized Sampling: How to Mitigate Mode Collapse and Unlock LLM Diversity},
  author={Zhang, Jiayi and Yu, Simon and Chong, Derek and Sicilia, Anthony and Tomz, Michael R and Manning, Christopher D and Shi, Weiyan},
  journal={arXiv preprint arXiv:2025.xxxxx},
  year={2025}
}`}
        language="bibtex"
        showLineNumbers={false}
      />
    </section>

  </main>
  <Footer />
</Layout>